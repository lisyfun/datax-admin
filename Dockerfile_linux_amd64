# 第一阶段：构建后端
FROM --platform=linux/amd64 golang:1.22.2-alpine as backend-builder
WORKDIR /app/backend
COPY backend/go.mod backend/go.sum ./
RUN go mod download
COPY backend .
RUN go build -o datax-admin .

# 第二阶段：最终镜像
FROM --platform=linux/amd64 nginx:1.25-alpine
WORKDIR /usr/share/nginx/html

# 设置时区
RUN apk add --no-cache tzdata && \
    cp /usr/share/zoneinfo/Asia/Shanghai /etc/localtime && \
    echo "Asia/Shanghai" > /etc/timezone && \
    apk del tzdata

# 复制前端构建产物
COPY frontend/dist .

# 复制后端二进制和配置
COPY --from=backend-builder /app/backend/datax-admin /app/datax-admin
COPY --from=backend-builder /app/backend/config.yaml /app/config.yaml
COPY --from=backend-builder /app/backend/bin/datax_linux_arm64 /app/bin/datax

# 复制 Nginx 配置
COPY nginx.conf /etc/nginx/nginx.conf

# 创建启动脚本
WORKDIR /app
RUN printf '#!/bin/sh\n\
./datax-admin & \n\
nginx -g "daemon off;"\n' > start.sh && \
chmod +x start.sh

EXPOSE 80
CMD ["sh", "/app/start.sh"]
